---
interface Props {
    event_classification: string;
    event_version: string;
}

const { event_classification, event_version } = Astro.props;
---

<div class="flex flex-col gap-y-4 mx-4 sm:mx-0 items-center w-full sm:max-w-lg md:max-w-xl">
    <div id="gallery-container" class="w-full">
        <div
            id="image-area"
            class="columns-2 md:columns-3 gap-2 space-y-2"
        >
            <!-- Dynamically generated by JS -->
        </div>
    </div>

    <button
        id="mobile-view-more"
        class="gallery-more sm:hidden rounded-lg mx-auto py-2 px-2 font-bold text-l dark:text-gray-200 shadow-md dark:shadow-black/25 border-solid border-2 border-amber-400 dark:border-amber-500 p-2 text-center hover:scale-105 transform transition-transform cursor-pointer"
    >
        See more photos
    </button>

    <button
        id="desktop-view-more"
        class="gallery-more hidden sm:block rounded-lg mx-auto py-2 px-2 font-bold text-l dark:text-gray-200 shadow-md dark:shadow-black/25 border-solid border-2 border-amber-400 dark:border-amber-500 p-2 text-center hover:scale-105 transform transition-transform cursor-pointer"
    >
        See more photos
    </button>
</div>

<!-- Lightbox Modal -->
<div id="lightbox" class="fixed inset-0 z-[100] hidden bg-black/95 flex items-center justify-center p-4">
    <button id="lightbox-close" class="absolute top-4 right-4 text-white/80 hover:text-white z-[110] p-2 rounded-full hover:bg-white/10 transition-colors" aria-label="Close lightbox">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
    </button>
    
    <button id="lightbox-prev" class="absolute left-4 text-white/80 hover:text-white z-[110] p-2 hidden md:block rounded-full hover:bg-white/10 transition-colors" aria-label="Previous image">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
    </button>
    
    <button id="lightbox-next" class="absolute right-4 text-white/80 hover:text-white z-[110] p-2 hidden md:block rounded-full hover:bg-white/10 transition-colors" aria-label="Next image">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
    </button>

    <div class="relative w-full h-full flex items-center justify-center pointer-events-none">
        <img id="lightbox-img" src="" alt="Event photo" class="pointer-events-auto max-h-[90vh] max-w-[90vw] object-contain rounded-sm shadow-2xl select-none" />
    </div>
    
    <!-- Mobile controls at bottom -->
    <div class="absolute bottom-8 left-0 right-0 flex justify-center gap-12 md:hidden z-[110]">
         <button id="lightbox-prev-mobile" class="text-white/90 bg-white/10 backdrop-blur-sm rounded-full p-3 active:scale-95 transition-transform" aria-label="Previous image">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>
        <button id="lightbox-next-mobile" class="text-white/90 bg-white/10 backdrop-blur-sm rounded-full p-3 active:scale-95 transition-transform" aria-label="Next image">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </button>
    </div>
</div>

<style>
    /* Custom scrollbar for lightbox */
    #lightbox img {
        max-height: 90vh;
    }
</style>

<script is:inline define:vars={{ event_classification, event_version }}>
    const imageArea = document.getElementById("image-area");
    const mobileViewMoreBtn = document.getElementById("mobile-view-more");
    const desktopViewMoreBtn = document.getElementById("desktop-view-more");
    
    // Lightbox elements
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightbox-img");
    const closeBtn = document.getElementById("lightbox-close");
    const prevBtn = document.getElementById("lightbox-prev");
    const nextBtn = document.getElementById("lightbox-next");
    const prevBtnMobile = document.getElementById("lightbox-prev-mobile");
    const nextBtnMobile = document.getElementById("lightbox-next-mobile");

    const r2_base = "https://event-assets.purduehackers.com/images";
    const event_base = `${r2_base}/${event_classification}/${event_version}`;
    const manifest_url = `${event_base}/index.json`;
    
    let allImageUrls = [];
    let currentImageIndex = 0;

    // Lightbox Logic
    const openLightbox = (index) => {
        currentImageIndex = index;
        updateLightboxImage();
        lightbox.classList.remove("hidden");
        document.body.style.overflow = "hidden";
    };

    const closeLightbox = () => {
        lightbox.classList.add("hidden");
        document.body.style.overflow = "";
    };

    const updateLightboxImage = () => {
        if (allImageUrls.length > 0) {
            // Preload next and previous images
            const nextIndex = (currentImageIndex + 1) % allImageUrls.length;
            const prevIndex = (currentImageIndex - 1 + allImageUrls.length) % allImageUrls.length;
            new Image().src = allImageUrls[nextIndex];
            new Image().src = allImageUrls[prevIndex];
            
            lightboxImg.src = allImageUrls[currentImageIndex];
        }
    };

    const showNext = (e) => {
        e?.stopPropagation();
        currentImageIndex = (currentImageIndex + 1) % allImageUrls.length;
        updateLightboxImage();
    };

    const showPrev = (e) => {
        e?.stopPropagation();
        currentImageIndex = (currentImageIndex - 1 + allImageUrls.length) % allImageUrls.length;
        updateLightboxImage();
    };

    // Event Listeners
    closeBtn.addEventListener("click", closeLightbox);
    prevBtn.addEventListener("click", showPrev);
    nextBtn.addEventListener("click", showNext);
    prevBtnMobile.addEventListener("click", showPrev);
    nextBtnMobile.addEventListener("click", showNext);
    
    lightbox.addEventListener("click", (e) => {
        if (e.target === lightbox) {
            closeLightbox();
        }
    });

    document.addEventListener("keydown", (e) => {
        if (lightbox.classList.contains("hidden")) return;
        
        if (e.key === "Escape") closeLightbox();
        if (e.key === "ArrowRight") showNext();
        if (e.key === "ArrowLeft") showPrev();
    });

    // Data Fetching
    const checkManifest = async () => {
        try {
            const res = await fetch(manifest_url, { method: "HEAD" });
            return res.status === 200;
        } catch (e) {
            return false;
        }
    };

    const fixViewMoreBtns = (count) => {
        if (count > 3) {
            const moreText = `See ${count - 3} more photos`;
            mobileViewMoreBtn.innerText = moreText;
            desktopViewMoreBtn.innerText = moreText;
            
            // Reveal hidden photos inline
            const reveal = () => {
                const hiddenItems = document.querySelectorAll(".hidden-gallery-item");
                hiddenItems.forEach(item => {
                    item.className = "w-full break-inside-avoid hover:scale-[1.03] transition transform cursor-pointer mb-2";
                    // Remove hidden class and ensure display is appropriate (block is default for div)
                    item.classList.remove("hidden");
                });
                mobileViewMoreBtn.style.display = "none";
                desktopViewMoreBtn.style.display = "none";
            };

            mobileViewMoreBtn.onclick = reveal;
            desktopViewMoreBtn.onclick = reveal;
        } else {
            mobileViewMoreBtn.style.display = "none";
            desktopViewMoreBtn.style.display = "none";
        }
    };

    const populateImages = async () => {
        if (await checkManifest()) {
            try {
                const res = await fetch(manifest_url);
                const manifest = await res.json();
    
                allImageUrls = manifest["images"].map((image) => {
                    return `${event_base}/${image.filename}`;
                });
    
                const image_count = allImageUrls.length;
    
                for (let i = 0; i < image_count; i++) {
                    const isHidden = i >= 3;
                    const img_url = allImageUrls[i];
    
                    const img_wrapper = document.createElement("div");
                    
                    if (isHidden) {
                        img_wrapper.className = "hidden-gallery-item hidden";
                    } else {
                        img_wrapper.className = "w-full break-inside-avoid hover:scale-[1.03] transition transform cursor-pointer mb-2";
                    }
                    
                    img_wrapper.onclick = () => openLightbox(i);
    
                    const img = document.createElement("img");
                    img.src = img_url;
                    img.className = "rounded-lg w-full";
    
                    img_wrapper.appendChild(img);
                    imageArea.appendChild(img_wrapper);
                }
    
                fixViewMoreBtns(image_count);
            } catch (e) {
                console.error("Failed to load images", e);
                fixViewMoreBtns(0);
            }
        } else {
            fixViewMoreBtns(0);
        }
    };

    populateImages().catch(() => {
        fixViewMoreBtns(0);
    });
</script>
